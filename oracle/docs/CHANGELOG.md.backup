# Changelog

Archived Recent Changes from DEV_CONTEXT.md.

---

### Recent Changes (Dec 22, 2025 - Session D98)
- **Fixed animations distribution** (`distribution.py`)
  - P13: `find_animations()` now looks up matchup from `ideas_approved.json`
  - Previously just parsed folder name (`idea_001` → `idea 001`) which didn't work
  - Now: `idea_001` → looks up `carousel_data.away_team/home_team` → `49ers @ Colts`
  - P13: Carousel with reels goes to `final/carousels/{timestamp}_{matchup}/` (slides + reels together)
- **Verified truth_prompt_wrapper integration** ✅
  - Confirmed wrapper IS being applied in `build_carousel_prompts()` (api_utils.py lines 2876-2886)
  - All key directives present: INK SPLATTER, DRIPS, paint explosion, 30/100% intensity, grass/turf spray, motion blur
  - **Archived** `truth_prompt_wrapper.py` → `scripts/archive/` (with d98_truth_wrapper_archive_note.md)
  - Mined future bucket ideas: `VISUAL_STYLE_BUCKETS` for ink_effects, environmental, motion, saturation

**D98 STATUS: COMPLETE**
- Distribution fix done
- Truth wrapper verified and archived

**Next Tasks:**
1. **[CRANK C10]** Test O67 pipeline end-to-end (carousel_illustrated_reels) - SF @ IND
2. **[DEV D99]** Integrate meme_mashup preset into O67 architecture

---

### Recent Changes (Dec 22, 2025 - Session D97)
- **O67 Platform Architecture IMPLEMENTED**
  - Created `scripts/data_source.py` - L1 platform for unified data fetching
    - `DataSourcePlatform` class routes to appropriate tool based on preset's `L1_tool`
    - `DataContext` and `NormalizedMatchup` dataclasses for cross-tool normalization
    - Supports: goatedbets_api, web_search, local_assets, balldontlie, odds_api
  - Created `PipelineOrchestrator` class in `content_pipeline.py`
    - `PipelineContext` dataclass: mode, phase, week, preset, matchup, l1_data, etc.
    - Reads preset's `layers` array and calls each layer sequentially
    - Layer runners: `_run_l1()` through `_run_l8()`
    - Falls back to legacy flow for presets without `layers` array
  - Updated presets with O67 fields (`config/script_presets.json`):
    - `carousel_illustrated`: `["L1", "L2", "L3", "L5", "L6", "L7"]` - skips L4 (no audio)
    - `carousel_illustrated_reels`: same layers + L6_tool=reel_converter
    - `best_bets_dark`: same layers + output_type=infographic
    - `short_form_video`: `["L1", "L2", "L3", "L4", "L5", "L6", "L7"]` - includes L4 (TTS)
    - `long_form_video`: same as short_form_video
  - Updated `_execute_generate()` and `_execute_discovery()` to use orchestrator
  - Both modes now symmetric: O67 path if preset has layers, legacy path otherwise
- **Added infographics distribution**
  - Added `--infographics` flag to `distribution.py`
  - Added `find_infographics()` and `distribute_infographic()` methods
  - Infographics → `final/infographics/` (separate from carousels)
  - Orchestrator's `_run_l7()` now passes correct flag based on `output_type`

**D97 STATUS: O67 COMPLETE** - Platform architecture in place

---

### Recent Changes (Dec 22, 2025 - Session D96)
- **Auto-update**: Modified scripts: data_source.py; docs: CHANGELOG.md
- **Fixed prompt leak on matchup slide** - "NFL logo Ided to essing" text was bleeding into image
  - Simplified `logo_prompt` in `api_utils.py` to single sentence
  - Removed explicit "LOGO AREA (TOP-LEFT CORNER)" sections from all slide prompts
  - Result: Clean images with no instruction text visible
- **Fixed discolored logo block** - Removed "RESERVED zone" language that AI interpreted as colored area
  - Cover, matchup, bonus prompts all simplified
  - Background now uniform cream across entire image
- **Removed team abbreviations from matchup edges** - Column header already shows team
  - `g_api_processor.py`: `select_best_entity()` no longer prefixes with team abbrev
  - `g_api_processor.py`: `_get_thesis_fallbacks()` returns phrases without team prefix
  - `api_utils.py`: Legacy fallbacks and variety pools updated (no team prefix)
  - Before: "SF 28% targets" → After: "28% targets"
  - Before: "IND home cooking" → After: "Home cooking"
- **Centered matchup header** - Removed left-margin positioning instructions
- **Full pipeline test** - SF @ IND carousel verified all fixes
  - Cost: $0.012 (2 regenerations)

**D96 STATUS: COMPLETE** - Prompt fixes and edge cleanup done

---

### Recent Changes (Dec 26, 2025 - Session P9)

**LLM-Powered Extraction Refactor:**
- **Regex → LLM migration** - Replaced 3 brittle regex functions with LLM-powered versions:
  - `extract_betting_thesis_llm()` - Identifies pass/run/situational thesis
  - `extract_cover_insight_llm()` - Generates 45-char setup/conflict/resolution bullets
  - `determine_predicted_winner_llm()` - Handles contrarian bets correctly
- **Smart wrapper functions** - `smart_extract_*()` wrappers auto-route to LLM or regex based on global toggle
- **Global toggle system** - `set_llm_extraction()` / `is_llm_extraction_enabled()` in api_utils.py
- **L0 menu integration** - Tool Configuration → [e] Toggle LLM Extraction
- **Session-level setting** - `ContentPipeline.use_llm_extraction` persists for session
- **Cost**: ~$0.0003/matchup (negligible), default ON for quality

**Smart Text Analysis Toolkit:**
- `analyze_for_highlights()` - Find key phrases for visual emphasis
- `analyze_for_buckets()` - Categorize text into themes (betting_prop, game_preview, etc.)
- `analyze_for_sentiment()` - Detect bullish/bearish/neutral for color coding
- `extract_entities()` - Pull out players, teams, stats
- `extract_key_stats()` - Structured stat extraction with context
- `summarize_to_length()` - Condense text to fit UI constraints

**Files modified**:
- `scripts/api_utils.py` (Smart Text Toolkit lines 144-790, LLM extraction lines 896-1324)
- `scripts/content_pipeline.py` (import, init, menu, toggle method, execution calls)

---

### Recent Changes (Dec 26, 2025 - Session P8)

**Asset Ingestion Text Removal Tools:**
- Integrated cleaning tools into ingestion (L1):
  - All cleaning operations now part of `ingest()` method
  - CLI flags: `--auto-crop`, `--crop-top/bottom/left/right`, `--strip-subs`, `--find-original`
  - Removed standalone crop/clean modes - everything flows through ingestion
- Text removal strategy documented:
  1. Find original source (best - no info loss, free)
  2. Cropping (quick fix when original unavailable)
  3. Runway ML (~$15/mo or ~$0.05/sec API)
  4. ProPainter (future - requires NVIDIA GPU)

**Files modified**: `scripts/asset_ingestion.py`

---

### Recent Changes (Dec 22, 2025 - Session D95)
- **Auto-update**: Modified scripts: api_utils.py, g_api_processor.py
- **Created `scripts/g_api_processor.py`** - GoatedBets API Processor (L3 layer)
  - Structured text extraction pipeline replacing ad-hoc patterns
  - Stage 1: Entity extraction (players, coaches, teams, stats from sentences)
  - Stage 2: Bucket organization (offense/defense/situational per team)
  - Stage 3: Layout formatting (30 char edges, 45 char cover insights)
  - Thesis alignment scoring for prioritizing relevant stats
  - Dataclasses: `ExtractedEntity`, `Stat`, `TeamBucket`, `MatchupBuckets`, `FormattedOutput`
- **Pre-refactor snapshot created:** `scripts/archive/d94_extraction_snapshot/`
- **New Rule #25 added:** "Pre-Refactor Snapshot Rule" - archive before major refactors
- **D95 Integration COMPLETE:**
  - Added `_get_g_api_processor()` lazy import in `api_utils.py`
  - Integrated into `transform_matchup_for_carousel()` with fallback to legacy extraction
  - Fixed sentence splitting to handle semicolons (proper player attribution)
  - Tested with real GoatedBets API (NE @ BAL):
    ```
    Cover Insights:
      1. Stakes high for BAL
      2. BAL matchup edge
      3. BAL covers the spread
    Matchup Edges:
      Away: ['NE 300 yds', 'NE tightens up', 'NE urgent mode']
      Home: ['Flowers 100 targets', 'BAL makes plays', 'BAL December form']
    ```
  - Compared with D94 snapshot - key patterns preserved (thesis alignment, attribution, char limits)

**D95 STATUS: COMPLETE** - Structured extraction pipeline integrated and tested

- **Fixed `fetch_goatedbets_matchup()` abbreviation matching** (idea_creation.py)
  - Added `abbrev_to_names` mapping for all 32 NFL teams
  - `matches_team()` helper expands abbreviations before matching
  - SF @ IND, JAX @ DEN, KC @ TEN, TB @ CAR all now work with abbreviations

---

### Recent Changes (Dec 21, 2025 - Session D94)
- **Auto-update**: Modified docs: CHANGELOG.md
- **Auto-update**: Modified scripts: api_utils.py, assembly.py
- **All C7 Crank issues resolved** - See section above for details
- **Universal enhancements** - Changes apply to ALL presets using GoatedBets API:
  - PLAYER_TEAMS reference dict used for player attribution
  - team_cities mapping for city-to-team resolution
  - No preset-specific hardcoding - modular design

---

